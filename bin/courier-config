#!/bin/sh

scriptdir="$(cd "$(dirname "$0")"; pwd)"
scriptname="$(basename "$0")"

export COURIER_CONFIG_DIR="${COURIER_CONFIG_DIR:-/etc/courier}"

grant_auth(){
  if ! [ -w "$COURIER_CONFIG_DIR" ] && ! [ -O "$COURIER_CONFIG_DIR" ]; then
    exec sudo -u $(stat --format=%U "$COURIER_CONFIG_DIR") "$scriptdir/$scriptname" "$@"
  fi
}

log(){
  echo "> $@"
  "$@"
  local res=$?
  echo "[exit $res]"
  return $res
}

case "$1" in
  createuser)
    grant_auth "$COURIER_CONFIG_DIR" "$@"
    
    log makeuserdb
    ;;
esac
